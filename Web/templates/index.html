{% extends 'base.html' %}
<!DOCTYPE html>
<html lang="en">

{% block content %}
    <div id="main-container" class="container" style="display: none;">
        <div class="parent-container-search-bar">
            <div class="search-bar">
                <div>
                    <button class="dropdown-cat-btn"><i class="fa-solid fa-bars"></i> Категории</button>
                    <ul class="dropdown-cat-menu">
                        {% for category in categories %}
                            <li>
                                <a href="#" class="dropdown-item" 
                                   data-category-name="{{ category }}">
                                   {{ category }}
                                </a>
                            </li>
                        {% endfor %}
                    </ul>
                </div>
                <!-- Search Input and Page Input -->
                <input type="text" class="search-input" id="search-input" placeholder="Monitor, tdi , tsi">
                <div>
                    <button class="dropdown-date-btn">Сортирај</button>
                    <ul class="dropdown-date-menu">
                        <li><button class="dropdown-date-item-btn">Најнови</button></li>
                        <li><button class="dropdown-date-item-btn">Најстари</button></li>
                        <li><button class="dropdown-date-item-btn">Најефтини</button></li>
                        <li><button class="dropdown-date-item-btn">Најскапи</button></li>
                    </ul>
                </div>
                <button class="search-btn" id="search-btn" onclick="handleSearch()"><i class="fa-solid fa-magnifying-glass"></i></button>
            </div>
        </div>
        <div class="checkbox-container">
            <div class="checkbox-div">
                <input type='checkbox' id='checkbox-title' class="checkbox" value="1" checked>
                <label for="checkbox-title"> Барај по наслов</label>
            </div>
            <div class="checkbox-div">
                <input type='checkbox' id='checkbox-desc' class="checkbox" value="1" checked>
                <label for="checkbox-desc"> Барај по опис</label>
            </div>
            <div class="checkbox-div">
                <input type='checkbox' id='checkbox-podogovor' class="checkbox" value="0" unchecked>
                <label for="checkbox-podogovor"> Отстрани огласи По Договор</label>
            </div>
            <div class="checkbox-div">
                <input type='checkbox' id='checkbox-price-1' class="checkbox" value="0" unchecked>
                <label for="checkbox-price-1"> Отстрани огласи со цена 1</label>
            </div>
        </div>
    </div>
    
    <!-- Ads Block (Hidden Initially) -->
    <div id="ads-container" class="block">
        <div class="ads-header">
            <h2>Филтрирани огласи</h2>
        </div>
        <div class="ads-grid"></div>
    </div>

    <!-- There is surplus code here somewhere can't fix now-->
    <script>
        let selectedCategory = null;  // Store the selected category globally

        // Function to show the main content
        document.addEventListener("DOMContentLoaded", function () {
            const getStartedBtns = document.querySelectorAll(".action-btn"); // Select all buttons
            const mainContainer = document.getElementById("main-container");

            // Initially hide the main content
            if (mainContainer) {
                mainContainer.style.display = "none";
            }

            getStartedBtns.forEach((btn) => {
                // Check if the button has been clicked before
                if (localStorage.getItem("getStartedClicked") === "true") {
                    btn.style.display = "none"; // Hide the button
                    if (mainContainer) {
                        mainContainer.style.display = "block"; // Show main content
                    }
                } else {
                    // Add click event listener for each button
                    btn.addEventListener("click", function (event) {
                        // Hide all "Get Started" buttons
                        getStartedBtns.forEach((b) => (b.style.display = "none"));

                        // Set flag in localStorage to hide button on future visits
                        localStorage.setItem("getStartedClicked", "true");

                        // Show the main content
                        if (mainContainer) {
                            mainContainer.style.display = "block";
                        }
                        window.location.hash = "#";
                    });
                }
            });
        });

        // Function to show the dropdown menu
        document.addEventListener("DOMContentLoaded", function () {
            const dropdownBtn = document.querySelector(".dropdown-cat-btn");
            const dropdownMenu = document.querySelector(".dropdown-cat-menu");

            // Toggle dropdown menu on button click
            dropdownBtn.addEventListener("click", function () {
                dropdownMenu.style.display = dropdownMenu.style.display === "block" ? "none" : "block";
            });

            // Close dropdown when clicking outside
            document.addEventListener("click", function (event) {
                if (!dropdownBtn.contains(event.target) && !dropdownMenu.contains(event.target)) {
                    dropdownMenu.style.display = "none";
                }
            });

            // Handle category selection
            dropdownMenu.addEventListener("click", function (event) {
                if (event.target.classList.contains("dropdown-item")) {
                    const categoryName = event.target.getAttribute("data-category-name");
                    selectedCategory = categoryName;  // Save selected category
                }
            });
        });
        
        // Function to show the dropdown menu for sorting via date or price
        document.addEventListener("DOMContentLoaded", function () {
            const DropdownDateBtn = document.querySelector(".dropdown-date-btn");
            const DropdownDateMenu = document.querySelector(".dropdown-date-menu");

            // Toggle dropdown menu on button click
            DropdownDateBtn.addEventListener("click", function () {
                DropdownDateMenu.style.display = DropdownDateMenu.style.display === "block" ? "none" : "block";
            });

            const sortButtons = document.querySelectorAll(".dropdown-date-item-btn");

            sortButtons.forEach(button => {
                button.addEventListener("click", function () {
                    const sortType = this.textContent.trim(); // Get the button text
                    handleSearch(sortType); // Call handleSearch with the sorting type
                });
            });
        });

        // Function to handle search
    document.addEventListener("DOMContentLoaded", function () {
        const sortButtons = document.querySelectorAll(".dropdown-date-item-btn");

        sortButtons.forEach(button => {
            button.addEventListener("click", function () {
                const sortType = this.textContent.trim();
                handleSearch(sortType);
            });
        });
    });

    document.addEventListener("DOMContentLoaded", function () {
        fetchAllAds(); // Fetch all ads when the page loads

        const sortButtons = document.querySelectorAll(".dropdown-date-item-btn");
        sortButtons.forEach(button => {
            button.addEventListener("click", function () {
                const sortType = this.textContent.trim();
                handleSearch(sortType);
            });
        });

        // Handle category selection
        document.querySelector(".dropdown-cat-menu").addEventListener("click", function (event) {
            if (event.target.classList.contains("dropdown-item")) {
                selectedCategory = event.target.getAttribute("data-category-name");
                handleSearch(); // Re-filter ads
            }
        });
    });

    let allAds = []; // Store all ads globally

    function fetchAllAds() {
        fetch('/fetch_ads', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ category: null }) // Fetch all ads
        })
        .then(response => response.json())
        .then(ads => {
            allAds = ads; // Store all ads globally
            displayAds(allAds); // Show all ads initially
        });
    }


    // Add event listeners for checkbox changes for podogovor and price1
    document.addEventListener("DOMContentLoaded", function () {
        document.getElementById("podogovorCheckbox").addEventListener("change", handleSearch);
        document.getElementById("price1Checkbox").addEventListener("change", handleSearch);
        document.getElementById("search-input").addEventListener("input", handleSearch);
        document.getElementById("checkbox-title").addEventListener("change", handleSearch);
        document.getElementById("checkbox-desc").addEventListener("change", handleSearch);
    });


    function handleSearch(sortType = "") {
    
        const searchInput = document.getElementById('search-input').value.trim().toLowerCase();
        const searchTitle = document.getElementById('checkbox-title').checked;
        const searchDesc = document.getElementById('checkbox-desc').checked;
        const podogovor = document.getElementById('checkbox-podogovor').checked;
        const price1 = document.getElementById('checkbox-price-1').checked;
        const adsGrid = document.querySelector(".ads-grid");
    

        // Step 1: Filter by category (if selected)
        let filteredAds = selectedCategory 
            ? allAds.filter(ad => ad.adcategory === selectedCategory) 
            : [...allAds];

        // Step 2: Apply keyword filtering ONLY if search input is NOT empty
        if (searchInput.length > 0) {
            let keywords = searchInput.split(',').map(k => k.trim().toLowerCase());
            filteredAds = filteredAds.filter(ad => {
                let match = false;
                if (searchTitle) match = keywords.every(keyword => ad.adtitle.toLowerCase().includes(keyword));
                if (searchDesc && !match) match = keywords.every(keyword => ad.addesc.toLowerCase().includes(keyword));
                return match;
            });
        }

        // Remove ads that are 1MKD or 1EUR and remove ads that are "ПоДоговор"
        if (podogovor) {
                filteredAds = filteredAds.filter(ad => ad.adcurrency !== "ПоДоговор");
            }
        if (price1) {
                filteredAds = filteredAds.filter(ad => ad.adprice !== 1);
            }

        // Step 3: Apply sorting
        if (sortType === "Најнови") {
            filteredAds.sort((a, b) => new Date(b.addate) - new Date(a.addate));
        } else if (sortType === "Најстари") {
            filteredAds.sort((a, b) => new Date(a.addate) - new Date(b.addate));
        } else if (sortType === "Најефтини") {
            filteredAds.sort((a, b) => a.adprice - b.adprice);
        } else if (sortType === "Најскапи") {
            filteredAds.sort((a, b) => b.adprice - a.adprice);
        }

        
        displayAds(filteredAds);
    }


    function displayAds(ads) {
        const adsGrid = document.querySelector(".ads-grid");
        adsGrid.innerHTML = ""; // Clear current ads

        let adsHtml = ads.length > 0 ? "" : "<p>Нема огласи за оваа категорија.</p>"; // Show message if empty

        ads.forEach(ad => {
            adsHtml += `
                <a href="${ad.adlink}" target="_blank" style="text-decoration: none;">
                    <div class="ad-block">
                        <div class="ad-header">
                            <div class="ad-title-info">
                                <div class="ad-title"><p>${ad.adtitle}</p></div>
                                <div class="ad-info">
                                    <p id="ad-date">${ad.addate}</p>
                                    <p id="ad-price">
                                        ${ad.adprice === 0 ?
                                        (ad.adcurrency === "ПоДоговор" ? "По Договор" : ad.adcurrency) 
                                        : ad.adprice + " " + (ad.adcurrency === "ПоДоговор" ? "По Договор" : ad.adcurrency)}
                                    </p>
                                </div>
                            </div>
                            <div class="ad-image"><img class="ad-img" src="${ad.adimage}"></div>
                        </div>
                        <div class="ad-description">
                            ${ad.addesc}
                        </div>
                    </div>
                </a>
        `;
        });

        adsGrid.innerHTML = adsHtml; // Append new ads
    }

    // Handle live search input
    document.getElementById("search-input").addEventListener("input", function () {
        handleSearch();
    });
        
    </script>
{% endblock content %}
</html>
