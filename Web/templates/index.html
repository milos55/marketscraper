{% extends 'base.html' %}
<!DOCTYPE html>
<html lang="en">

{% block content %}
    <div id="main-container" class="container">
        <div class="parent-container-search-bar">
            <div class="search-bar">
                <!-- Category Dropdown -->
                <div class="dropdown">
                    <button class="dropdown-cat-btn" aria-label="Categories">
                        <i class="fa-solid fa-bars"></i> Категории
                    </button>
                    <ul class="dropdown-cat-menu">
                        <div class="grid-container">
                            {% for category in categories %}
                                <li>
                                    <button class="category-btn" 
                                            data-category="{{ category }}">
                                        {{ category }}
                                    </button>
                                </li>
                            {% endfor %}
                        </div>
                    </ul>
                </div>
                <!-- Search Input -->
                <input type="text" 
                       class="search-input" 
                       id="search-input" 
                       placeholder="Monitor, tdi, tsi"
                       aria-label="Search input">

                <!-- Sort Dropdown -->
                <div class="dropdown">
                    <button class="dropdown-date-btn" aria-label="Sort options">Сортирај</button>
                    <ul class="dropdown-date-menu">
                        <li><button class="sort-btn" data-sort="newest">Најнови</button></li>
                        <li><button class="sort-btn" data-sort="oldest">Најстари</button></li>
                        <li><button class="sort-btn" data-sort="cheapest">Најефтини</button></li>
                        <li><button class="sort-btn" data-sort="expensive">Најскапи</button></li>
                    </ul>
                </div>

                <button class="search-btn" 
                        id="search-btn" 
                        aria-label="Search">
                    <i class="fa-solid fa-magnifying-glass"></i>
                </button>
            </div>
        </div>

        <!-- Search Options -->
        <div class="checkbox-container">
            <label class="checkbox-div">
                <input type="checkbox" id="checkbox-title" checked>
                Барај по наслов
            </label>
            <label class="checkbox-div">
                <input type="checkbox" id="checkbox-desc" checked>
                Барај по опис
            </label>
            <label class="checkbox-div">
                <input type="checkbox" id="checkbox-podogovor">
                Отстрани огласи По Договор
            </label>
            <label class="checkbox-div">
                <input type="checkbox" id="checkbox-price-1">
                Отстрани огласи со цена 1
            </label>
        </div>
    </div>
    
    <!-- Ads Container -->
    <div id="ads-container" class="block">
        <div class="ads-header">
            <h2>Филтрирани огласи</h2>
        </div>
        <div class="ads-grid"></div>
        <div class="pagination-container">
            <div class="pagination">
                <button class="page-btn" id="prev-page">Prev</button>
                <span class="page-number">Page 1</span>
                <button class="page-btn" id="next-page">Next</button>
            </div>
        </div>
    </div>

    <script>
        class AdsManager {
            constructor() {
                this.allAds = [];
                this.currentPage = 1;
                this.adsPerPage = 48;
                this.selectedCategory = null;
                this.currentSort = null;
                this.filteredAds = [];
                
                this.initializeElements();
                this.setupEventListeners();
                this.fetchAllAds();
            }

            initializeElements() {
                this.elements = {
                    mainContainer: document.getElementById('main-container'),
                    searchInput: document.getElementById('search-input'),
                    adsGrid: document.querySelector('.ads-grid'),
                    categoryMenu: document.querySelector('.dropdown-cat-menu'),
                    dateMenu: document.querySelector('.dropdown-date-menu'),
                    categoryBtn: document.querySelector('.dropdown-cat-btn'),
                    dateBtn: document.querySelector('.dropdown-date-btn'),
                    checkboxes: {
                        title: document.getElementById('checkbox-title'),
                        desc: document.getElementById('checkbox-desc'),
                        podogovor: document.getElementById('checkbox-podogovor'),
                        price1: document.getElementById('checkbox-price-1')
                    },
                    pagination: {
                        prevBtn: document.getElementById('prev-page'),
                        nextBtn: document.getElementById('next-page'),
                        pageNumber: document.querySelector('.page-number')
                    }
                };
            }

            setupEventListeners() {
                // Dropdowns
                this.elements.categoryBtn.addEventListener('click', () => {
                    this.elements.categoryMenu.style.display = 
                        this.elements.categoryMenu.style.display === 'block' ? 'none' : 'block';
                });

                this.elements.dateBtn.addEventListener('click', () => {
                    this.elements.dateMenu.style.display = 
                        this.elements.dateMenu.style.display === 'block' ? 'none' : 'block';
                });

                // Close dropdowns when clicking outside
                document.addEventListener('click', (e) => {
                    if (!e.target.matches('.dropdown-cat-btn')) {
                        this.elements.categoryMenu.style.display = 'none';
                    }
                    if (!e.target.matches('.dropdown-date-btn')) {
                        this.elements.dateMenu.style.display = 'none';
                    }
                });

                // Category selection
                document.querySelectorAll('.category-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        this.selectedCategory = e.target.dataset.category;
                        this.elements.categoryMenu.style.display = 'none';
                        this.currentPage = 1;
                        this.handleSearch();
                    });
                });

                // Sort selection
                document.querySelectorAll('.sort-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        this.currentSort = e.target.dataset.sort;
                        this.elements.dateMenu.style.display = 'none';
                        this.handleSearch();
                    });
                });

                // Search input
                let debounceTimer;
                this.elements.searchInput.addEventListener('input', () => {
                    clearTimeout(debounceTimer);
                    debounceTimer = setTimeout(() => this.handleSearch(), 300);
                });

                // Checkboxes
                Object.values(this.elements.checkboxes).forEach(checkbox => {
                    checkbox.addEventListener('change', () => this.handleSearch());
                });

                // Pagination
                this.elements.pagination.prevBtn.addEventListener('click', () => {
                    if (this.currentPage > 1) {
                        this.currentPage--;
                        this.displayAds();
                    }
                    document.body.scrollTo({top: 0, behavior: 'smooth'});
                    document.documentElement.scrollTo({top: 0, behavior: 'smooth'});
                });

                this.elements.pagination.nextBtn.addEventListener('click', () => {
                    const maxPages = Math.ceil(this.filteredAds.length / this.adsPerPage);
                    if (this.currentPage < maxPages) {
                        this.currentPage++;
                        this.displayAds();
                    }

                    // Scroll to the top
                    document.body.scrollTo({top: 0, behavior: 'smooth'});
                    document.documentElement.scrollTo({top: 0, behavior: 'smooth'});
                });
            }

            async fetchAllAds() {
                try {
                    const response = await fetch('/fetch_ads', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ category: null })
                    });
                    this.allAds = await response.json();
                    this.handleSearch();
                } catch (error) {
                    console.error('Error fetching ads:', error);
                    this.elements.adsGrid.innerHTML = '<p>Error loading ads. Please try again later.</p>';
                }
            }

            filterAds() {
                const searchTerms = this.elements.searchInput.value.trim().toLowerCase().split(',').map(term => term.trim());
                
                let filtered = this.allAds;

                // Category filter
                if (this.selectedCategory) {
                    filtered = filtered.filter(ad => ad.adcategory === this.selectedCategory);
                }

                // Search terms filter
                if (searchTerms[0] !== '') {
                    filtered = filtered.filter(ad => {
                        const titleMatch = this.elements.checkboxes.title.checked && 
                            searchTerms.every(term => ad.adtitle.toLowerCase().includes(term));
                        const descMatch = this.elements.checkboxes.desc.checked && 
                            searchTerms.every(term => ad.addesc.toLowerCase().includes(term));
                        return titleMatch || descMatch;
                    });
                }

                // Price filters
                if (this.elements.checkboxes.podogovor.checked) {
                    filtered = filtered.filter(ad => ad.adcurrency !== "ПоДоговор");
                }
                if (this.elements.checkboxes.price1.checked) {
                    filtered = filtered.filter(ad => ad.adprice !== 1);
                }

                return filtered;
            }

            sortAds(ads) {
                const sortedAds = [...ads];
                switch (this.currentSort) {
                    case 'newest':
                        sortedAds.sort((a, b) => new Date(b.addate) - new Date(a.addate));
                        break;
                    case 'oldest':
                        sortedAds.sort((a, b) => new Date(a.addate) - new Date(b.addate));
                        break;
                    case 'cheapest':
                        sortedAds.sort((a, b) => parseFloat(a.adprice) - parseFloat(b.adprice));
                        break;
                    case 'expensive':
                        sortedAds.sort((a, b) => parseFloat(b.adprice) - parseFloat(a.adprice));
                        break;
                }
                return sortedAds;
            }

            handleSearch() {
                this.filteredAds = this.sortAds(this.filterAds());
                this.displayAds();
                this.updatePagination();
            }

            displayAds() {
                const start = (this.currentPage - 1) * this.adsPerPage;
                const end = start + this.adsPerPage;
                const pageAds = this.filteredAds.slice(start, end);

                this.elements.adsGrid.innerHTML = pageAds.length ? 
                    pageAds.map(ad => this.createAdHTML(ad)).join('') : 
                    '<p>Нема огласи за оваа категорија.</p>';

                this.updatePagination();
            }

            createAdHTML(ad) {
                return `
                    <a href="${ad.adlink}" target="_blank" class="ad-link">
                        <div class="ad-block">
                            <div class="ad-header">
                                <div class="ad-title-info">
                                    <div class="ad-title">${ad.adtitle}</div>
                                    <div class="ad-info">
                                        <time datetime="${ad.addate}">${ad.addate}</time>
                                        <span class="ad-price">
                                            ${this.formatPrice(ad.adprice, ad.adcurrency)}
                                        </span>
                                    </div>
                                </div>
                            </div>
                            <div class="ad-description">
                                <div class="ad-description-text">${ad.addesc}</div>
                                ${this.getImageHTML(ad.adimage)}
                            </div>
                        </div>
                    </a>
                `;
            }

            formatPrice(price, currency) {
                if (currency === "ПоДоговор") return "По Договор";
                return price === 0 ? currency : `${price} ${currency}`;
            }

            getImageHTML(imageUrl) {
                if (imageUrl === "/Content/images/noImage2.jpg") return '';
                return `<div class="ad-image">
                    <img class="ad-img" src="${imageUrl}" loading="lazy" alt="">
                </div>`;
            }

            updatePagination() {
                const totalPages = Math.ceil(this.filteredAds.length / this.adsPerPage);
                this.elements.pagination.prevBtn.disabled = this.currentPage === 1;
                this.elements.pagination.nextBtn.disabled = this.currentPage === totalPages;
                this.elements.pagination.pageNumber.innerHTML = `
                    Page <input type="number" class="page-input" value="${this.currentPage}" min="1" max="${totalPages}" id="pageInput"> / ${totalPages}
                `;
            }
        }

        // Initialize when DOM is ready
        document.addEventListener('DOMContentLoaded', () => new AdsManager());
    </script>
{% endblock content %}
</html>